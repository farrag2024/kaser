<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تسجيل درجات الاختبارات القصيرة</title>
    <link rel="icon" href="9999.png" type="image/png">
    <style>
        .exit-button {
        background-color: red; /* لون الخلفية */
        color: white; /* لون النص */
        border: none; /* إزالة الحدود */
        padding: 10px 20px; /* إضافة حشوة */
        text-align: center; /* محاذاة النص */
        text-decoration: none; /* إزالة التسطير */
        display: inline-block; /* عرض الزر ككتلة */
        font-size: 16px; /* حجم الخط */
        margin-top: 20px; /* إضافة مسافة أعلى الزر */
        cursor: pointer; /* تغيير شكل المؤشر عند المرور فوق الزر */
        border-radius: 5px; /* زوايا دائرية */
        font-weight: bold;  
    }
        body {
            background-image: url('222.jpg'); /* إذا كانت الصورة في مجلد فرعي */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            text-align: center;
        }
        table {
            margin: 0 auto; /* توسيط الجدول */
        }
        #studentTable {
            display: none; /* إخفاء الجدول عند التحميل */
            margin-top: 20px; /* إضافة مسافة أعلى الجدول */
            border-collapse: collapse; /* دمج الحدود */
        }

        table,
        th,
        td {
            background-color: #f7e9d6;
            border: 1px solid black;
            padding: 8px;
            font-weight: bold;
            font-size: 16px;
        }
        /* تحديد عرض الأعمدة */
        th:nth-child(1), td:nth-child(1) { /* عمود م */
            width: 40px; /* عرض عمود المسلسل (تصغير) */
        }
        th:nth-child(2), td:nth-child(2) { /* عمود الصف */
            width: 20px; /* عرض عمود الصف (تصغير) */
        }
        th:nth-child(3), td:nth-child(3) { /* عمود اسم الطالب */
            width: 250px; /* عرض عمود اسم الطالب (توسيع) */
        }
        th:nth-child(4), td:nth-child(4), /* عمود المواد */
        th:nth-child(5), td:nth-child(5),
        th:nth-child(6), td:nth-child(6),
        th:nth-child(7), td:nth-child(7),
        th:nth-child(8), td:nth-child(8),
        th:nth-child(9), td:nth-child(9),
        th:nth-child(10), td:nth-child(10),
        th:nth-child(11), td:nth-child(11) {
            width: 20px; /* عرض الأعمدة الأخرى (تصغير) */
        }

        input {
            width: 50px;
            font-weight: bold;
            font-size: 14px;   
        }
        input.student-name {
         width: 250px;               /* عرض الحقل */
         font-size: 16px;            /* حجم الخط */
         color: #640404;   
         font-weight: bold;             /* لون النص */
       
        }
        input.row.cl_num {
         width: 55px;               /* عرض الحقل */
         font-size: 16px;            /* حجم الخط */
         color: #333;   
         font-weight: bold;             /* لون النص */
       
        }
        

        .filter-container {
            margin-bottom: 10px;
        }

        .save-button {
            background-color: #4CAF50; /* لون الخلفية */
            color: white; /* لون النص */
            border: none; /* إزالة الحدود */
            padding: 10px 20px; /* إضافة حشوة */
            text-align: center; /* محاذاة النص */
            text-decoration: none; /* إزالة التسطير */
            display: inline-block; /* عرض الزر ككتلة */
            font-size: 16px; /* حجم الخط */
            margin: 4px 2px; /* إضافة هوامش */
            cursor: pointer; /* تغيير شكل المؤشر عند المرور فوق الزر */
            border-radius: 5px; /* زوايا دائرية */
            font-weight: bold;  
        } 
        select {
            background-color: hsl(195, 83%, 82%);
            font-size: 18px;
            font-style: normal;
            font: bold;
            padding: 5px;
            width: 120px;
            height: 40px;
            border: 2px solid #010a01;
            border-radius: 20px;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1); /* إضافة ظل */
        }
        .show-button {
            background-color: blue; /* لون الخلفية */
            color: white; /* لون النص */
            border: none; /* إزالة الحدود */
            padding: 10px 20px; /* إضافة حشوة */
            text-align: center; /* محاذاة النص */
            text-decoration: none; /* إزالة التسطير */
            display: inline-block; /* عرض الزر ككتلة */
            font-size: 16px; /* حجم الخط */
            margin: 4 px 2px; /* إضافة هوامش */
            cursor: pointer; /* تغيير شكل المؤشر عند المرور فوق الزر */
            border-radius: 5px; /* زوايا دائرية */
            font-weight: bold;  
        }
        /* تنسيق الشعار */
        .logo {
            margin-top: 10px;
            width: 150px; /* تعديل حجم الشعار */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* ظل للشعار */
            height: auto;
        }
        .readonly-field {
            border: none;
            background-color: transparent;
            pointer-events: none; /* تعطيل القدرة على التعديل */
            font-family: inherit;
            font-size: inherit;
        }
        #updateAllStudents {
            background-color: #4CAF50; /* لون الخلفية */
            color: white; /* لون النص */
            border: none; /* إزالة الحدود */
            padding: 10px 20px; /* إضافة حشوة */
            text-align: center; /* محاذاة النص */
            text-decoration: none; /* إزالة التسطير */
            display: inline-block; /* عرض الزر ككتلة */
            font-size: 16px; /* حجم الخط */
            margin: 4px 2px; /* إضافة هوامش */
            cursor: pointer; /* تغيير شكل المؤشر عند المرور فوق الزر */
            border-radius: 5px; /* زوايا دائرية */
            font-weight: bold;  
        }
    </style>
</head>
<body>
    <img src="9999.png" alt="Logo" class="logo">
    <h1>رصد درجات الاختبار القصير الاول 25/24</h1>
     <!-- رسالة الحفظ -->
     <div id="loadingMessage" style="color: blue; font-weight: bold; display: none; margin-bottom: 10px;">
        جاري الحفظ، برجاء الانتظار...
    </div>

    <!-- Filter and Show Table Button -->
    <div class="filter-container">
     <!-- <label for="classFilter">الصف:</label> -->
     <select id="classFilter" onchange="updateSubjects()">
        <option value="">اختار الصف</option>
        <option value="خامس 1">خامس 1</option>
        <option value="خامس 2">خامس 2</option>
        <option value="خامس 3">خامس 3</option>
        <option value="خامس 4">خامس 4</option>
        <option value="سادس 1">سادس 1</option>
        <option value="سادس 2">سادس 2</option>
        <option value="سادس 3">سادس 3</option>
        <option value="سادس 4">سادس 4</option>
        <option value="سابع 1">سابع 1</option>
        <option value="سابع 2">سابع 2</option>
        <option value="سابع 3">سابع 3</option>
        <option value="سابع 4">سابع 4</option>
        <option value="ثامن 1">ثامن 1</option>
        <option value="ثامن 2">ثامن 2</option>
        <option value="ثامن 3">ثامن 3</option>
        <option value="ثامن 4">ثامن 4</option>
        <option value="تاسع 1">تاسع 1</option>
        <option value="تاسع 2">تاسع 2</option>
        <option value="تاسع 3">تاسع 3</option>
        <option value="تاسع 4">تاسع 4</option>
        <option value="عاشر 1">عاشر 1</option>
        <option value="عاشر 2">عاشر 2</option>
        <option value="عاشر 3">عاشر 3</option>
        <option value="عاشر 4">عاشر 4</option>
    </select>
    
    <select id="subjectFilter">
        <option value="">-- اختار المادة --</option>
        <option value="aslm">التربية الاسلامية</option>
        <option value="arb">اللغة العربية</option>
        <option value="math">الرياضيات</option>
        <option value="since">العلوم</option>
        <option value="drasa">الدراسات</option>
        <option value="eng">اللغة الانجليزية</option>
        <option value="fyz">فيزياء</option>
        <option value="kims">كيمياء</option>
        <option value="ahya">احياء</option>
    </select>
    
    <script>
    function updateSubjects() {
        const classFilterValue = document.getElementById('classFilter').value;
        const subjectFilter = document.getElementById('subjectFilter');
        
        // استعادة جميع الخيارات
        const allOptions = [
            { value: "aslm", text: "التربية الاسلامية" },
            { value: "arb", text: "اللغة العربية" },
            { value: "math", text: "الرياضيات" },
            { value: "since", text: "العلوم" },
            { value: "drasa", text: "الدراسات" },
            { value: "eng", text: "اللغة الانجليزية" },
            { value: "fyz", text: "فيزياء" },
            { value: "kims", text: "كيمياء" },
            { value: "ahya", text: "احياء" },
        ];
    
        // حذف جميع الخيارات الموجودة حاليًا
        subjectFilter.innerHTML = '<option value="">-- اختار المادة --</option>';
    
        // إضافة الخيارات المناسبة بناءً على الصف المختار
        allOptions.forEach(option => {
            if ((classFilterValue.includes("خامس") || classFilterValue.includes("سادس") || classFilterValue.includes("سابع") || classFilterValue.includes("ثامن")) && (option.value === "fyz" || option.value === "kims" || option.value === "ahya")) {
                // لا تضف فيزياء وكيمياء وأحياء
                return;
            }
            if ((classFilterValue.includes("تاسع") || classFilterValue.includes("عاشر")) && option.value === "since") {
                // لا تضف العلوم
                return;
            }
            const newOption = document.createElement('option');
            newOption.value = option.value;
            newOption.text = option.text;
            subjectFilter.appendChild(newOption);
        });
    }
    </script>

        <button onclick="showTable()" class="show-button">عــرض</button>
        <button onclick="updateAllStudents()" class="save-button"style="display: none;">حفظ الدرجات</button>
        <button id="updateAllStudents" onclick="updateAllStudents()" style="display: none;">حفظ التعديلات</button>

    </div>
    

    <!-- Table to display the data -->
    <table id="studentTable">
        <thead>
            <tr>
                <th>م</th>
                <th>الصف</th>
                <th>اسم الطالب</th>
                <th>اسلامية</th>
                <th>عربي</th>
                <th>رياضيات</th>
                <th>علوم</th>
                <th>دراسات</th>
                <th>انجليزي</th>
                <th>فيزياء</th>
                <th>كيمياء</th>
                <th>احياء</th>
            </tr>
        </thead>
        <tbody>
            <!-- Data will be populated here -->
        </tbody>
    </table>
    <button onclick="closePage()" class="exit-button">خروج</button>
<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbztCJGQzunQW6HJen1ggtgZ-IlQISvqzQ85_7_g0H3UmJM_Ya28fFiGIu1-922Gmiej/exec';
   
    function closePage() {
        window.close(); // يغلق الصفحة
      }
    function loadData() {
        fetch(scriptURL)
            .then(response => response.json())
            .then(data => {
                const tableBody = document.querySelector("#studentTable tbody");
                tableBody.innerHTML = ''; // Clear existing data

                data.forEach((row) => {
                    const newRow = document.createElement("tr");

                    newRow.innerHTML = `
                        <td>${row.id}</td>
                        <td><input type="text" class="cl_num" value="${row.cl_num}" id="cl_num_${row.id}" readonly></td>
                        <td><input type="text" class="student-name" value="${row.student_name}" id="student_name_${row.id}" readonly></td>
                     <td>
    <input type="number" 
           value="${row.aslm}" 
           id="aslm_${row.id}" 
           data-original="${row.aslm}" 
           min="0" 
           max="35" 
           oninput="if (this.value.length > 2) { alert('يرجى إدخال رقم مكون من رقمين كحد أقصى.'); this.value = this.value.slice(0, 2); }">
</td>
<td>
    <input type="number" 
           value="${row.arb}" 
           id="arb_${row.id}" 
           data-original="${row.arb}" 
           min="0" 
           max="35" 
           oninput="if (this.value.length > 2) { alert('يرجى إدخال رقم مكون من رقمين كحد أقصى.'); this.value = this.value.slice(0, 2); }">
</td>
<td>
    <input type="number" 
           value="${row.math}" 
           id="math_${row.id}" 
           data-original="${row.math}" 
           min="0" 
           max="35" 
           oninput="if (this.value.length > 2) { alert('يرجى إدخال رقم مكون من رقمين كحد أقصى.'); this.value = this.value.slice(0, 2); }">
</td>
<td>
    <input type="number" 
           value="${row.since}" 
           id="since_${row.id}" 
           data-original="${row.since}" 
           min="0" 
           max="35" 
           oninput="if (this.value.length > 2) { alert('يرجى إدخال رقم مكون من رقمين كحد أقصى.'); this.value = this.value.slice(0, 2); }">
</td>
<td>
    <input type="number" 
           value="${row.drasa}" 
           id="drasa_${row.id}" 
           data-original="${row.drasa}" 
           min="0" 
           max="35" 
           oninput="if (this.value.length > 2) { alert('يرجى إدخال رقم مكون من رقمين كحد أقصى.'); this.value = this.value.slice(0, 2); }">
</td>
<td>
    <input type="number" 
           value="${row.eng}" 
           id="eng_${row.id}" 
           data-original="${row.eng}" 
           min="0" 
           max="35" 
           oninput="if (this.value.length > 2) { alert('يرجى إدخال رقم مكون من رقمين كحد أقصى.'); this.value = this.value.slice(0, 2); }">
</td>
<td>
    <input type="number" 
           value="${row.fyz}" 
           id="fyz_${row.id}" 
           data-original="${row.fyz}" 
           min="0" 
           max="35" 
           oninput="if (this.value.length > 2) { alert('يرجى إدخال رقم مكون من رقمين كحد أقصى.'); this.value = this.value.slice(0, 2); }">
</td>
<td>
    <input type="number" 
           value="${row.kims}" 
           id="kims_${row.id}" 
           data-original="${row.kims}" 
           min="0" 
           max="35" 
           oninput="if (this.value.length > 2) { alert('يرجى إدخال رقم مكون من رقمين كحد أقصى.'); this.value = this.value.slice(0, 2); }">
</td>
<td>
    <input type="number" 
           value="${row.ahya}" 
           id="ahya_${row.id}" 
           data-original="${row.ahya}" 
           min="0" 
           max="35" 
           oninput="if (this.value.length > 2) { alert('يرجى إدخال رقم مكون من رقمين كحد أقصى.'); this.value = this.value.slice(0, 2); }">
</td>


                    `;

                    tableBody.appendChild(newRow);
                });
            });
        }
        function showTable() {
            const classFilterValue = document.getElementById('classFilter').value;
            const subjectFilterValue = document.getElementById('subjectFilter').value;

            if (classFilterValue && subjectFilterValue) {
                document.getElementById('studentTable').style.display = 'table'; // عرض الجدول
                document.getElementById('updateAllStudents').style.display = 'inline-block'; // إظهار زر الحفظ

                filterData(classFilterValue, subjectFilterValue); // تطبيق الفلترة
            } else {
                alert('برجاء اختيار الصف و المادة معاً.');
            }
        }
        function filterData(classFilterValue, subjectFilterValue) {
            const tableBody = document.querySelector("#studentTable tbody");
            const rows = tableBody.querySelectorAll("tr");
            const headers = document.querySelectorAll("#studentTable th");

            rows.forEach(row => {
                const classNumber = row.cells[1].querySelector('input').value; // Class number

                if (classNumber.includes(classFilterValue)) {
                    row.style.display = ''; // Show row

                    // Hide all subjects except the selected one and basic info
                    for (let i = 3; i <= 11; i++) {
                        if (i === getColumnIndex(subjectFilterValue)) {
                            row.cells[i].style.display = ''; // Show selected subject
                        } else {
                            row.cells[i].style.display = 'none'; // Hide other subjects
                        }
                    }
                    // Hide other headers
                    for (let i = 3; i <= 11; i++) {
                        if (i === getColumnIndex(subjectFilterValue)) {
                            headers[i].style.display = ''; // Show selected header
                        } else {
                            headers[i].style.display = 'none'; // Hide other headers
                        }
                    }
                } else {
                    row.style.display = 'none'; // Hide row if class doesn't match
                }
            });
        }

        function getColumnIndex(subject) {
            const subjectColumns = {
                "aslm": 3,
                "arb": 4,
                "math": 5,
                "since": 6,
                "drasa": 7,
                "eng": 8,
                "fyz": 9,
                "kims": 10,
                "ahya": 11
            };
            return subjectColumns[subject];
        }

        function updateAllStudents() {
        const tableBody = document.querySelector("#studentTable tbody");
        const rows = tableBody.querySelectorAll("tr");
        const promises = [];

        document.getElementById('loadingMessage').style.display = 'block';

        rows.forEach((row) => {
            const id = row.cells[0].textContent;
            const formData = new FormData();
            let hasChanges = false;

            // تحضير البيانات وتحديد التغييرات
            ["aslm", "arb", "math", "since", "drasa", "eng", "fyz", "kims", "ahya"].forEach(subject => {
                const input = document.getElementById(`${subject}_${id}`);
                const originalValue = input.dataset.original;

                if (input.value !== originalValue) {
                    formData.append(subject, input.value);
                    hasChanges = true;
                } else {
                    formData.append(subject, originalValue);  // إضافة الحقول التي لم تتغير بالقيمة الحالية
                }
            });

            // إضافة معلومات الطالب فقط إذا حدث تغيير
            if (hasChanges) {
                formData.append('id', id);
                formData.append('cl_num', document.getElementById(`cl_num_${id}`).value);
                formData.append('student_name', document.getElementById(`student_name_${id}`).value);
                promises.push(fetch(scriptURL, { method: 'POST', body: formData }));
            }
        });

         // التعامل مع الاستجابة
         Promise.all(promises)
            .then(responses => Promise.all(responses.map(response => response.json())))
            .then(data => {
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('studentTable').style.display = 'none';
                document.getElementById('updateAllStudents').style.display = 'none'; // إظهار زر الحفظ


                if (data.every(result => result.status === 'updated')) {
                    alert('تم الحفظ بنجاح ،شكراً!');
                } else {
                    alert('فشل في تحديث بعض السجلات.');
                }
                 // تحديث الصفحة بعد العملية
            location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('loadingMessage').style.display = 'none';
            alert('حدث خطأ أثناء حفظ البيانات.');
        });
              }
          
            const numberInputs = document.querySelectorAll('input[type="number"]');

function validateValue(input) {
    if (input.value < 0) {
        input.value = 0; 
        showMessage('يرجى إدخال رقم موجب فقط.');
    } else if (input.value > 35) {
        input.value = 35; 
        showMessage('الرجاء التأكد من الدرجة.');
    }
}

function showMessage(message) {
    alert(message); // يمكنك تعديل هذا الجزء لعرض الرسالة بطريقة أفضل
}

numberInputs.forEach(input => {
    input.addEventListener('input', function() {
        validateValue(this);
    });

    input.addEventListener('keydown', function(event) {
        if (event.key === '-' || event.key === 'ArrowLeft' || event.key === 'ArrowRight') {
            event.preventDefault();
        }
    });

    input.addEventListener('keypress', function(event) {
        // منع إدخال أي حرف غير الأرقام
        if (!/[0-9]/.test(event.key) && event.key !== 'Backspace' && event.key !== 'Tab') {
            event.preventDefault();
        }

        // تحقق من طول القيمة الجديدة بعد إدخال الرقم
        const newValue = this.value + event.key;

        // منع إدخال أرقام أكبر من عددين
        if (newValue.length > 2) {
            event.preventDefault();
            showMessage('يرجى إدخال رقم مكون من رقمين كحد أقصى.');
        }

        // منع إدخال أرقام أكبر من 35
        if (parseInt(newValue) > 35) {
            event.preventDefault();
            showMessage('الرجاء التأكد من الدرجة .');
        }
    });

    input.addEventListener('blur', function() {
        validateValue(this);
    });
});


        
    window.onload = loadData; // Load data when the page loads
</script>
